"""
Plot exploitability comparison between adaptive and regular Nash PG.

Usage:
    uv run scripts/plot_exploitability.py
"""

import json
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path
from typing import List, Tuple, Dict


def load_exploitability_data(log_file_path: str):
    """Load exploitability data from JSON log file.

    Args:
        log_file_path: Path to the JSON log file

    Returns:
        Tuple of (steps, exploitability_values)
    """
    with open(log_file_path, 'r') as f:
        log_data = json.load(f)

    if 'eval' not in log_data:
        raise ValueError(f"No eval data found in {log_file_path}")

    eval_data = log_data['eval']
    steps = [entry['step'] for entry in eval_data]
    exploitability = [entry['exploitability'] for entry in eval_data]

    return steps, exploitability


def compute_true_exploitability(exploitability_values, nash_value=1/18):
    """Compute true exploitability by subtracting Nash equilibrium value.

    For Kuhn Poker, the Nash equilibrium value from Player 0's perspective is +1/18.
    True exploitability = max(0, observed_return - nash_value)

    Args:
        exploitability_values: Raw return values from exploiting agent
        nash_value: Nash equilibrium value for the game (default: 1/18 for Kuhn Poker)

    Returns:
        List of true exploitability values (non-negative)
    """
    return [max(0, val - nash_value) for val in exploitability_values]


def plot_comparison(json_files: List[Tuple[str, str]], output_file: str = "exploitability_comparison.png", nash_value: float = 1/18):
    """Plot exploitability comparison for multiple JSON files.

    Args:
        json_files: List of tuples (file_path, label) for each JSON file to plot
        output_file: Path to save the output plot
        nash_value: Nash equilibrium value for the game (default: 1/18 for Kuhn Poker)
    """
    # Load data from all files
    all_data = []
    for file_path, label in json_files:
        if not Path(file_path).exists():
            print(f"Warning: File not found: {file_path}, skipping...")
            continue
        steps, exploit = load_exploitability_data(file_path)
        true_exploit = compute_true_exploitability(exploit, nash_value)
        all_data.append({
            'label': label,
            'steps': steps,
            'raw_exploit': exploit,
            'true_exploit': true_exploit
        })

    if not all_data:
        print("Error: No valid data files found")
        return

    # Create figure with two subplots
    fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(14, 5))

    # Plot 1: Raw exploitability values (as computed by the script)
    for data in all_data:
        ax1.plot(data['steps'], data['raw_exploit'], label=data['label'], linestyle='-', alpha=0.7, linewidth=2)
    ax1.axhline(y=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.5, label='Zero line')
    ax1.axhline(y=nash_value, color='red', linestyle='--', linewidth=0.8, alpha=0.5, label=f'Nash value ({nash_value:.4f})')
    ax1.set_xlabel('Training Steps')
    ax1.set_ylabel('Exploiting Agent Return')
    ax1.set_title('Raw Exploitability Values')
    ax1.legend()
    ax1.grid(True, alpha=0.3)

    # Plot 2: True exploitability (corrected by subtracting Nash value)
    # for data in all_data:
    #     print(f"\n{data['label']}:"
    #     print(f"length of raw exploitability: {len(data['raw_exploit'])}"))
    for data in all_data:
        ax2.plot(data['steps'], data['true_exploit'], label=data['label'], linestyle='-', alpha=0.7, linewidth=2)
    ax2.axhline(y=0, color='gray', linestyle='--', linewidth=0.8, alpha=0.5, label='Nash equilibrium')
    ax2.set_xlabel('Training Steps')
    ax2.set_ylabel('True Exploitability')
    ax2.set_title('True Exploitability (Return - Nash Value)')
    ax2.legend()
    ax2.grid(True, alpha=0.3)
    ax2.set_ylim(bottom=-0.01)  # Start slightly below zero to show the axis

    plt.tight_layout()
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"Plot saved to {output_file}")
    # plt.show()  # Commented out for CLI usage

    # Print summary statistics
    print("\n=== Summary Statistics ===")
    for data in all_data:
        print(f"\n{data['label']}:")
        print(f"  Final raw exploitability: {data['raw_exploit'][-1]:.6f}")
        print(f"  Final true exploitability: {data['true_exploit'][-1]:.6f}")
        print(f"  Min raw exploitability: {min(data['raw_exploit']):.6f}")
        print(f"  Max raw exploitability: {max(data['raw_exploit']):.6f}")


def main():
    """Main function to plot exploitability comparison."""
    # Define list of JSON files with their labels
    json_files = [
        ("logs/kuhn_poker/nash_pg/nash_pg_cv.json", "Kuhn CV"),
        ("logs/kuhn_poker/nash_pg/nash_pg_no_cv.json", "Kuhn No CV"),
        ("logs/leduc_poker/nash_pg/nash_pg_cv.json", "Leduc CV"),
        ("logs/leduc_poker/nash_pg/nash_pg_no_cv.json", "Leduc No CV"),
    ]
    game = "comparison"
    nash_value = 0.0  # Use 0 for comparison across games
    output_file = f"exploitability_comparison_{game}.png"

    # Generate plot
    plot_comparison(json_files, output_file, nash_value)

    return 0


if __name__ == "__main__":
    exit(main())